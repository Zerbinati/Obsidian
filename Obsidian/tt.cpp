#include "tt.h"

#include <iostream>

using namespace std;

namespace TT {

  Entry* entries = nullptr;
  uint64_t entryCount;

  void clear() {
    for (uint64_t i = 0; i < entryCount; i++)
      entries[i].clear();
  }

  void resize(size_t megaBytes) {
    size_t bytes = megaBytes * 1024ULL * 1024ULL;
    entryCount = bytes / sizeof(Entry);

    if (entries != nullptr)
      delete[] entries;

    entries = new Entry[entryCount];
    clear();
  }

  uint64_t index(Key key) {
    using uint128 = unsigned __int128;
    return (uint128(key) * uint128(entryCount)) >> 64;
  }

  void prefetch(Key key) {
#if defined(_MSC_VER)
    _mm_prefetch((char*)&entries[index(key)], _MM_HINT_T0);
#else
    __builtin_prefetch(&entries[index(key)]);
#endif
  }

  Entry* probe(Key key, bool& hit) {
    Entry* entry = &entries[index(key)];
    hit = entry->matches(key);
    return entry;
  }

  void age() {
    for (uint64_t i = 0; i < entryCount; i++)
      entries[i].age();
  }
}